-- title:  Voxel rendering demo
-- author: tomas7777
-- desc:   Voxel raytracer
-- script: lua

--TIC80 constants
--(screen dimensions and frametime)
SW,SH=240,136
DT=1/60
--Demo constants
FOV=90
VIEW_DIST=32
COLORS_TEX={
	[1]=13,
	[2]=5,
}
I_LEAVE=2
PLR_SPEED=6
PLR_RSPEED=math.rad(120)
--Debug
AVG_FPS=true

function Init()
	t=0
	camPos={0.5,0.5,0.5}
	camMatrix={{1,0,0},{0,1,0},{0,0,1}}
	camLengthX=math.tan(math.rad(FOV/2))
	camLengthY=math.tan(math.rad(FOV/2))*SH/SW
	camLengthX=camLengthX/(SW/2)
	camLengthY=camLengthY/(SH/2)
	zbuf={}
	for x=0,SW-1 do
		zbuf[x]=math.huge
	end
	GenerateMap()
end

function GenerateMap()
	M={}
	for x=0,31 do
		M[x]={}
		for y=0,31 do
			M[x][y]={}
			for z=0,31 do
				M[x][y][z]=math.random(0,2)
			end
		end
	end
end

function TIC()
	local i_time=time()
	ProcessInput()
	if I_LEAVE==1 then
		cls()
	else
		for y=(t//I_LEAVE)%I_LEAVE,SH-1,I_LEAVE do
			for x=t%I_LEAVE,SW-1,I_LEAVE do
				poke4(x+y*240,0)
			end
		end
	end
	DrawVoxels()
	DrawFPS(time()-i_time,AVG_FPS)
	t=t+1
end

function ProcessInput()
	if btn(6) then
		if btn(0) then
			camPos=translate(camPos,scale(getY(camMatrix),-PLR_SPEED*DT))
		elseif btn(1) then
			camPos=translate(camPos,scale(getY(camMatrix),PLR_SPEED*DT))
		end
		if btn(2) then
			camPos=translate(camPos,scale(getX(camMatrix),-PLR_SPEED*DT))
		elseif btn(3) then
			camPos=translate(camPos,scale(getX(camMatrix),PLR_SPEED*DT))
		end
	else
		if btn(0) then
			camMatrix=transformSpace(camMatrix,rotMatX(PLR_RSPEED*DT))
		elseif btn(1) then
			camMatrix=transformSpace(camMatrix,rotMatX(-PLR_RSPEED*DT))
		end
		if btn(2) then
			camMatrix=transformSpace(rotMatY(-PLR_RSPEED*DT),camMatrix)
		elseif btn(3) then
			camMatrix=transformSpace(rotMatY(PLR_RSPEED*DT),camMatrix)
		end
	end
	
	if btn(4) then
		camPos=translate(camPos,scale(getZ(camMatrix),PLR_SPEED*DT))
	elseif btn(5) then
		camPos=translate(camPos,scale(getZ(camMatrix),-PLR_SPEED*DT))
	end
end

function DrawVoxels()
	for y=(t//I_LEAVE)%I_LEAVE,SH-1,I_LEAVE do
		for x=t%I_LEAVE,SW-1,I_LEAVE do
			local lengthX=camLengthX*(x-SW/2)
			local lengthY=camLengthY*(y-SH/2)
			local rayDir=translate(getZ(camMatrix),
				scale(getX(camMatrix),lengthX))
			rayDir=translate(rayDir,
				scale(getY(camMatrix),lengthY))
			local dirx,diry,dirz=
			getX(rayDir),getY(rayDir),getZ(rayDir)
			local hit_id,final_dist,hit_side=
			CastRay(getX(camPos),getY(camPos),getZ(camPos),
			        dirx,diry,dirz)
			if hit_id~=0 and hit_id<=127 then
				zbuf[x]=final_dist
				pix(x,y,COLORS_TEX[hit_id]+hit_side)
			end
		end
	end
end

function CastRay(ox,oy,oz,dirx,diry,dirz)
	--Distance in ray between
	--x, y, and z units
	local d_distx,d_disty,d_distz
	if dirx==0 then
		--YZ ray
		d_disty=Length(0,1,dirz/diry)
		d_distz=Length(0,diry/dirz,1)
	elseif diry==0 then
		--XZ ray
		d_distx=Length(1,0,dirz/dirx)
		d_distz=Length(dirx/dirz,0,1)
	elseif dirz==0 then
		--XY ray
		d_distx=Length(1,diry/dirx,0)
		d_disty=Length(dirx/diry,1,0)
	else
		d_distx=Length(1,diry/dirx,dirz/dirx)
		d_disty=Length(dirx/diry,1,dirz/diry)
		d_distz=Length(dirx/dirz,diry/dirz,1)
	end
	--Player distance to next
	--x, y or z unit
	local distx,disty,distz
	if dirx<0 then
		distx=ox%1
	else
		distx=1-ox%1
	end
	if diry<0 then
		disty=oy%1
	else
		disty=1-oy%1
	end
	if dirz<0 then
		distz=oz%1
	else
		distz=1-oz%1
	end
	distx=math.abs(distx)
	disty=math.abs(disty)
	distz=math.abs(distz)
	--Distance in ray to next
	--x, y or z unit
	local sidex,sidey,sidez
		=math.huge,math.huge,math.huge
	if d_distx then
		sidex=d_distx*distx
	end
	if d_disty then
		sidey=d_disty*disty
	end
	if d_distz then
		sidez=d_distz*distz
	end
	--Start casting
	local mapx,mapy,mapz=ox//1,oy//1,oz//1
	local hit_id=0
	local hit_side=0 --0 for x, 1 for y, 2 for z
	local dist_count=0
	local stepx,stepy,stepz=
	Sign(dirx),Sign(diry),Sign(dirz)
	while dist_count<VIEW_DIST do
		if sidex<=sidey and sidex<=sidez then
			--Closer to x unit
			mapx=mapx+stepx
			sidex=sidex+d_distx
			hit_side=0
		elseif sidey<sidex and sidey<sidez then
			--Closer to y unit
			mapy=mapy+stepy
			sidey=sidey+d_disty
			hit_side=1
		else
			--Closer to z unit
			mapz=mapz+stepz
			sidez=sidez+d_distz
			hit_side=2
		end
		local tile_id=MGet3D(mapx,mapy,mapz)
		if tile_id>0 and tile_id<=127 then
			hit_id=tile_id
			break
		else
			dist_count=dist_count+1
		end
	end
	--Calculate distance
	local final_dist
	if hit_side==0 then
		final_dist=sidex-d_distx
	elseif hit_side==1 then
		final_dist=sidey-d_disty
	else
		final_dist=sidez-d_distz
	end
	--Fisheye correction
	local dirL=Length(dirx,diry,dirz)
	final_dist=final_dist/dirL

	return hit_id,final_dist,hit_side
end

function DrawDebugMap()
	map(0,0,16,16,0,0,0)
	spr(257,plr.x*8,plr.y*8)
end

function DrawFPS(frametime,avg)
	if avg then
		if not _avg_ftimes then
			_avg_ftimes={}
		end
		local a=_avg_ftimes
		table.insert(a,frametime)
		if #a>60 then
			table.remove(a,1)
		end
		local sum=0
		for i=1,#a do
			sum=sum+a[i]
		end
		frametime=sum/#a
	end
	local fps=1000/frametime
	print("FPS: "..
	(avg and math.floor(fps) or fps),0,0,12)
end

function Sign(x)
	if x==0 then
		return 0
	else
		return x/math.abs(x)
	end
end

function MGet3D(x,y,z)
	if not M[x] then return 0 end
	if not M[x][y] then return 0 end
	return M[x][y][z] or 0
end

--Vector/matrix functions
--Matrices in column major
function Length(x,y,z)
	return math.sqrt(x^2+y^2+z^2)
end

function getX(p)
	return p[1]
end

function getY(p)
	return p[2]
end

function getZ(p)
	return p[3]
end

function translate(p,v)
	return {p[1]+v[1],
	p[2]+v[2],
	p[3]+v[3]}
end

function scale(v,s)
	return {v[1]*s,v[2]*s,v[3]*s}
end

function transform(mat,p)
	--Multiply matrix by point
	return translate(scale(mat[1],getX(p)),
		translate(scale(mat[2],getY(p)),
		scale(mat[3],getZ(p))))
end

function transformSpace(mat,space)
	local col1=transform(mat,getX(space))
	local col2=transform(mat,getY(space))
	local col3=transform(mat,getZ(space))
	return {{col1[1],col1[2],col1[3]},
	{col2[1],col2[2],col2[3]},
	{col3[1],col3[2],col3[3]}}
end

function rotMatX(t)
	return {{1,0,0},{0,math.cos(t),math.sin(t)},{0,-math.sin(t),math.cos(t)}}
end

function rotMatY(t)
	return {{math.cos(t),0,-math.sin(t)},{0,1,0},{math.sin(t),0,math.cos(t)}}
end

function rotMatZ(t)
	return {{math.cos(t),math.sin(t),0},{-math.sin(t),math.cos(t),0},{0,0,1}}
end

--
Init()
-- <TILES>
-- 001:dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd
-- 002:9999999999999999999999999999999999999999999999999999999999999999
-- 128:022222202222c22222222c222cccccc222222c222222c2222222222202222220
-- 129:0aaaaaa0aaaaaaaaac0cc0caaccccccaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaa0
-- </TILES>

-- <SPRITES>
-- 001:eccccccccc888888caaaaaaaca888888cacccccccacc0ccccacc0ccccacc0ccc
-- 002:ccccceee8888cceeaaaa0cee888a0ceeccca0ccc0cca0c0c0cca0c0c0cca0c0c
-- 003:1111111122312222111111112223122222231222111111112222223111111111
-- 004:1111111131222223111111112222312322223123111111112222222311111111
-- 005:8888808888880098888800880000008888808088888080888880008980808088
-- 006:0088888088080880880808008808000080000888888088889880888888008888
-- 007:feeeeeeefeefefeefeeeefeefeeeefefffefeffffeeeefeffeeeeeeefeeeefee
-- 008:efeeeeeefeeeefeefeeeffeeffeeefeefefeefefeeeffffeefeffffffefeffff
-- 009:0000080000000800000008000000080000000800888888880000080000000800
-- 010:0008000000080000000800000008000000080000888888880008000000080000
-- 013:00000000000000000000000000000000000000000000000b0000000000000000
-- 017:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
-- 018:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
-- 019:2231222222312222111111112222222311111111222312222223122211111111
-- 020:2312222323122223111111111222222311111111222312232223122311111111
-- 021:8800808888008088888080898880809888808088888080888800008888888088
-- 022:8000888888808088888088808800000088008880888088800000888008888888
-- 023:ffeeefeefeeefeeffeefeeeffeeeeeeffeefeeefffefefefffefeeeeffeeefee
-- 024:ffeffffeffeeffeefeeeffeffeeefeefffeefeefffeffeeffffeeeefeeefeeff
-- 025:0000080000000800000008008888888800000800000008000000080000000800
-- 026:0008000000080000000800008888888800080000000800000008000000080000
-- 028:000000000000000000000000000000000000c000000000000000000000000000
-- 045:0000000000000000000000000000000000000000000000000000000000b00000
-- 046:000c000000000000000000000000000000000000000000000000000000000000
-- 059:0000000000000000000000c00000000000000000000000000000000000000000
-- </SPRITES>

-- <MAP>
-- 000:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:100000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:100000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:100000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:100000000000000000000000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:100000000010101010101000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:100000000010000000000000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:100000000010000000000000000000100000200000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:100000000010000008001000000000100000200000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:100000000010000000001000000000100000200000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:100000000010101010101000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:100000000000000000000000000000100000000000000000202020000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:100000000000000000000000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:100000000000000000000000000000100000200000100000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:100000000000000000000000000000100000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:101010101010000000001010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:100000180000000000000000180000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 019:100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 020:100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 021:101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

